{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["/**\n * Buildbot server\n */\n'use strict';\n\nconst _ = require('lodash-node');\nconst freeportAsync = require('freeport-async');\n\nconst koa = require('koa');\nconst api = require('@exponent/koa-api');\nconst identify = require('koa-identify');\nconst logger = require('koa-logger');\nconst router = require('koa-router');\n\nconst buildAsync = require('./buildAsync');\nconst ngrokAsync = require('./ngrokAsync');\n\nlet BuildbotApi = {\n\n    build: {\n      doc: \"Runs a build and returns the result if successful\",\n      methodAsync: async function (env, args) {\n        buildAsync().then((result) => {\n\n        }, (err) => {\n        });\n\n        return true;\n\n      },\n    },\n\n    add: {\n      doc: \"Adds two numbers and returns the result\",\n      methodAsync: function (env, args) {\n        console.log(\"Called methodAsync\");\n        return new Promise(function (resolve, reject) {\n          var sum = 0;\n          for (var i = 0; i < args.length; i++) {\n            if (!_.isNumber(args[i])) {\n              var err = api.ApiError('TYPE_ERROR', args[i] + \" is not a number!\");\n              console.error(err);\n              return reject(err);\n            } else {\n              sum += args[i];\n            }\n          }\n          console.log(\"Added up\", args, \"to get\", sum);\n          return resolve(sum);\n        });\n      },\n   },\n};\n\nvar app = koa();\napp.name = 'buildbot';\napp.proxy = true;\napp.experimental = true;\n\napp.use(logger());\napp.use(identify());\napp.use(api(app, BuildbotApi));\n\nif (require.main === module) {\n  (async function () {\n    let argv = require('minimist')(process.argv.slice(2));\n    let port = argv.port || argv.p || await freeportAsync(3500);\n\n    let server = app.listen(port, function () {\n      let addr = server.address();\n      let port = addr.port;\n      let host = addr.address;\n      console.log('Listening on http://' + host + ':' + port + ' using NODE_ENV=' + process.env.NODE_ENV);\n    });\n\n    try {\n      let url = await ngrokAsync({port});\n      console.log(\"Tunneling to port\", port, \"via ngrok at\", url);\n    } catch (e) {\n      console.error(\"Failed to start ngrok tunnel!\\n\", e, e.stack);\n      process.exit(-2);\n    }\n\n  })().then((result) => {\n    if (result) {\n      console.log(result);\n    }\n  }, (err) => {\n    console.error(err, err.stack);\n  });\n}\n\nmodule.exports = app;\n"],"sourceRoot":"/source/"}